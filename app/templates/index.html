{% extends "base.html" %}

{% block title %}Home - Thai-English Grammar Learning Tool{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        {% if current_user.is_authenticated %}
        <div class="card shadow">
            <div class="card-body">
                <h1 class="card-title text-center mb-4">
                    <i class="bi bi-chat-text" aria-hidden="true"></i> Thai-English Grammar Learning Tool
                </h1>
                
                <p class="text-center text-muted mb-4">
                    Enter a Thai sentence to analyse its English translation and tense
                </p>

                <form method="POST" action="{{ url_for('main.predict') }}" id="analyseForm" novalidate>
                    <div class="mb-4">
                        <label for="thai_text" class="form-label">
                            <i class="bi bi-pencil-square" aria-hidden="true"></i> Thai Sentence
                        </label>
                        <textarea 
                            class="form-control form-control-lg" 
                            id="thai_text" 
                            name="thai_text" 
                            rows="3" 
                            placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                            required
                            autofocus
                            aria-describedby="thai-text-help thai-text-examples textStats"
                            aria-invalid="false"
                        ></textarea>
                        <div id="thai-text-help" class="form-text">
                            Enter Thai text to analyze its English translation and grammatical tense
                        </div>
                        <div id="thai-text-examples" class="form-text">
                            Example: ‡∏â‡∏±‡∏ô‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏ä‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô, ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡∏â‡∏±‡∏ô‡πÑ‡∏õ‡∏ï‡∏•‡∏≤‡∏î, ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏â‡∏±‡∏ô‡∏à‡∏∞‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </div>
                        
                        <!-- Validation feedback -->
                        <div id="validationFeedback" class="mt-2" role="alert" aria-live="polite"></div>
                        
                        <!-- Text statistics -->
                        <div id="textStats" class="mt-2 d-none" aria-live="polite">
                            <div class="row text-center">
                                <div class="col-3">
                                    <small class="text-muted">
                                        <i class="bi bi-123" aria-hidden="true"></i> 
                                        <span id="tokenCount" aria-label="Token count">0</span>/500
                                    </small>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">
                                        <i class="bi bi-translate" aria-hidden="true"></i> 
                                        <span id="thaiPercentage" aria-label="Thai percentage">0</span>% Thai
                                    </small>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">
                                        <i class="bi bi-text-paragraph" aria-hidden="true"></i> 
                                        <span id="sentenceCount" aria-label="Sentence count">0</span> sentences
                                    </small>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">
                                        <i class="bi bi-speedometer2" aria-hidden="true"></i> 
                                        <span id="validationStatus" aria-label="Validation status">Ready</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" 
                                aria-describedby="submit-help">
                            <i class="bi bi-play-circle" aria-hidden="true"></i> Analyse
                        </button>
                        <div id="submit-help" class="visually-hidden">
                            Submit Thai text for translation and grammatical analysis
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Progress Bar Container -->
        <div id="progressContainer" class="d-none mt-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title text-center mb-3">
                        <i class="bi bi-gear-fill"></i> Processing Analysis
                    </h5>
                    
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progressBar" 
                             class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                             role="progressbar" 
                             style="width: 0%"
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <div id="progressIcon" style="font-size: 3rem;" class="mb-2">üîÑ</div>
                        <h6 id="progressText" class="mb-1">Starting analysis...</h6>
                        <p id="progressTextThai" class="text-muted small mb-0">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer" class="d-none mt-4">
            <!-- Results will be dynamically inserted here -->
        </div>

        <!-- Information Cards -->
        <div class="row mt-4">
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-translate text-primary" style="font-size: 2rem;" aria-hidden="true"></i>
                        <h5 class="card-title mt-2">Translation</h5>
                        <p class="card-text small">
                            Thai to English using Typhoon Translate 4B
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-tags text-success" style="font-size: 2rem;" aria-hidden="true"></i>
                        <h5 class="card-title mt-2">Classification</h5>
                        <p class="card-text small">
                            Tense detection using XLM-RoBERTa
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-lightbulb text-warning" style="font-size: 2rem;" aria-hidden="true"></i>
                        <h5 class="card-title mt-2">Explanation</h5>
                        <p class="card-text small">
                            Grammar tips using Typhoon 2.1 Instruct
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-keyboard text-info" style="font-size: 2rem;" aria-hidden="true"></i>
                        <h5 class="card-title mt-2">Keyboard Shortcuts</h5>
                        <div class="card-text small text-start">
                            <p class="mb-1"><kbd>Alt + S</kbd> Focus input</p>
                            <p class="mb-1"><kbd>Alt + Enter</kbd> Submit</p>
                            <p class="mb-0"><kbd>Escape</kbd> Clear text</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Not logged in message -->
        <div class="card shadow">
            <div class="card-body text-center py-5">
                <i class="bi bi-lock" style="font-size: 4rem; color: #6c757d;"></i>
                <h2 class="mt-3 mb-3">Login Required</h2>
                <p class="text-muted mb-4">
                    Please log in with your 5-digit pseudocode to access the Thai-English Grammar Learning Tool
                </p>
                <a href="{{ url_for('auth.login') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-box-arrow-in-right"></i> Go to Login
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if current_user.is_authenticated %}
<script>
    let validationTimeout;
    let isValidInput = false;
    
    // Real-time validation as user types
    document.getElementById('thai_text').addEventListener('input', function() {
        clearTimeout(validationTimeout);
        const text = this.value.trim();
        
        if (text.length === 0) {
            document.getElementById('textStats').classList.add('d-none');
            document.getElementById('validationFeedback').innerHTML = '';
            this.setAttribute('aria-invalid', 'false');
            isValidInput = false;
            return;
        }
        
        // Show loading state
        document.getElementById('textStats').classList.remove('d-none');
        document.getElementById('validationStatus').textContent = 'Checking...';
        
        // Debounce validation requests
        validationTimeout = setTimeout(() => {
            validateInput(text);
        }, 300);
    });
    
    // Keyboard navigation support
    document.addEventListener('keydown', function(e) {
        // Alt + S to focus on textarea
        if (e.altKey && e.key === 's') {
            e.preventDefault();
            document.getElementById('thai_text').focus();
        }
        
        // Alt + Enter to submit form
        if (e.altKey && e.key === 'Enter') {
            e.preventDefault();
            const form = document.getElementById('analyseForm');
            if (isValidInput) {
                form.submit();
            }
        }
        
        // Escape to clear textarea
        if (e.key === 'Escape' && document.activeElement === document.getElementById('thai_text')) {
            document.getElementById('thai_text').value = '';
            document.getElementById('textStats').classList.add('d-none');
            document.getElementById('validationFeedback').innerHTML = '';
            isValidInput = false;
        }
    });
    
    function validateInput(text) {
        fetch('/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ text: text })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Validation error:', data.error);
                return;
            }
            
            updateValidationUI(data);
        })
        .catch(error => {
            console.error('Validation request failed:', error);
            document.getElementById('validationStatus').textContent = 'Error';
        });
    }
    
    function updateValidationUI(data) {
        // Update text statistics
        document.getElementById('tokenCount').textContent = data.token_count;
        document.getElementById('thaiPercentage').textContent = Math.round(data.thai_percentage);
        document.getElementById('sentenceCount').textContent = data.sentence_count;
        
        // Update token count color
        const tokenElement = document.getElementById('tokenCount');
        const tokenUsage = data.usage_percentage;
        tokenElement.className = '';
        if (tokenUsage >= 90) {
            tokenElement.className = 'text-danger fw-bold';
        } else if (tokenUsage >= 80) {
            tokenElement.className = 'text-warning fw-bold';
        } else {
            tokenElement.className = 'text-success';
        }
        
        // Update Thai percentage color
        const thaiElement = document.getElementById('thaiPercentage');
        thaiElement.className = '';
        if (data.thai_percentage >= 80) {
            thaiElement.className = 'text-success';
        } else if (data.thai_percentage >= 60) {
            thaiElement.className = 'text-warning';
        } else {
            thaiElement.className = 'text-danger';
        }
        
        // Update validation status
        const statusElement = document.getElementById('validationStatus');
        const textArea = document.getElementById('thai_text');
        isValidInput = data.is_valid;
        
        if (data.is_valid) {
            statusElement.textContent = data.has_warnings ? 'Valid (warnings)' : 'Valid';
            statusElement.className = data.has_warnings ? 'text-warning' : 'text-success';
            textArea.setAttribute('aria-invalid', 'false');
        } else {
            statusElement.textContent = 'Invalid';
            statusElement.className = 'text-danger';
            textArea.setAttribute('aria-invalid', 'true');
        }
        
        // Update submit button state
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = !data.is_valid;
        submitBtn.setAttribute('aria-disabled', !data.is_valid);
        
        // Clear any previous validation messages
        document.getElementById('validationFeedback').innerHTML = '';
        
        // Show warnings if any
        if (data.has_warnings) {
            showValidationWarnings();
        }
    }
    
    function showValidationWarnings() {
        const warningHtml = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ö‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.getElementById('validationFeedback').innerHTML = warningHtml;
    }
    
    // Enhanced form submission with validation
    document.getElementById('analyseForm').addEventListener('submit', function(e) {
        const thai_text = document.getElementById('thai_text').value.trim();
        
        if (!thai_text) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / Please enter Thai text');
            e.preventDefault();
            return;
        }
        
        if (!isValidInput) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á / Please fix validation errors before submitting');
            e.preventDefault();
            return;
        }
        
        // Show progress bar and disable form
        const progressContainer = document.getElementById('progressContainer');
        const submitBtn = document.getElementById('submitBtn');
        
        progressContainer.classList.remove('d-none');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Processing...';
        
        // Start mock progress animation
        startMockProgress();
        
        // Let the form submit normally - don't prevent it
        // The progress bar will show during the actual processing
    });
    
    function startMockProgress() {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressTextThai = document.getElementById('progressTextThai');
        const progressIcon = document.getElementById('progressIcon');
        
        let currentStep = 1;
        let currentProgress = 0;
        
        const steps = [
            {step: 1, duration: 1500, endProgress: 33, message: "Translating...", messageThai: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•...", icon: "üî§"},
            {step: 2, duration: 1500, endProgress: 66, message: "Classifying tense...", messageThai: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Å‡∏≤‡∏•...", icon: "üè∑Ô∏è"},
            {step: 3, duration: 6500, endProgress: 100, message: "Generating explanation...", messageThai: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢...", icon: "üí°"}
        ];
        
        function animateStep(stepIndex) {
            if (stepIndex >= steps.length) return;
            
            const step = steps[stepIndex];
            const startProgress = stepIndex === 0 ? 0 : steps[stepIndex - 1].endProgress;
            const progressIncrement = (step.endProgress - startProgress) / (step.duration / 50);
            
            // Update step info
            progressText.textContent = step.message;
            progressTextThai.textContent = step.messageThai;
            progressIcon.textContent = step.icon;
            
            const progressInterval = setInterval(() => {
                currentProgress += progressIncrement;
                
                if (currentProgress >= step.endProgress) {
                    currentProgress = step.endProgress;
                    progressBar.style.width = currentProgress + '%';
                    progressBar.setAttribute('aria-valuenow', currentProgress);
                    
                    clearInterval(progressInterval);
                    
                    // Move to next step after a brief pause
                    setTimeout(() => {
                        animateStep(stepIndex + 1);
                    }, 200);
                } else {
                    progressBar.style.width = currentProgress + '%';
                    progressBar.setAttribute('aria-valuenow', currentProgress);
                }
            }, 50);
        }
        
        // Start the animation
        animateStep(0);
    }
</script>
{% endif %}
{% endblock %}