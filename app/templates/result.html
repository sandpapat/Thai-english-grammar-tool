{% extends "base.html" %}

{% block title %}Results - Thai-English Grammar Learning Tool{% endblock %}

{% block extra_css %}
<style>
    /* Star Rating Styles */
    .rating-stars {
        font-size: 1.5rem;
        cursor: pointer;
    }
    
    .rating-star {
        color: #ddd;
        transition: color 0.2s ease;
        margin-right: 0.25rem;
    }
    
    .rating-star:hover,
    .rating-star.active {
        color: #ffc107;
    }
    
    .rating-star.active {
        color: #ffc107 !important;
    }
    
    .rating-stars:hover .rating-star {
        color: #ddd;
    }
    
    .rating-stars:hover .rating-star:hover,
    .rating-stars:hover .rating-star:hover ~ .rating-star {
        color: #ffc107;
    }
    
    /* Reverse the hover effect for stars after hovered star */
    .rating-stars .rating-star:hover ~ .rating-star {
        color: #ddd !important;
    }
    
    #ratingCard {
        border-left: 4px solid #ffc107;
    }
    
    /* Analyzed Sentence Highlighting */
    .analyzed-sentence {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid #2196f3;
        font-family: var(--font-universal);
        line-height: 1.6;
    }
    
    .analyzed-sentence:hover {
        background: linear-gradient(135deg, #bbdefb 0%, #e1bee7 100%);
        transition: background 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Results Header -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">
                    <i class="bi bi-check-circle text-success me-2"></i>Analysis Results
                </h2>
                
                <!-- Input and Translation -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-chat-left-text me-2"></i>Thai Input
                                </h5>
                                <p class="card-text fs-5" lang="th">{{ result.input_thai }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-translate me-2"></i>English Translation
                                </h5>
                                <p class="card-text fs-5">{{ result.translation }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Multi-sentence Analysis Notice -->
                {% if result.is_multi_sentence %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <div>
                                <strong>Multi-sentence Input Detected</strong><br>
                                <small>Multiple sentences were found in your translation. Only the first sentence was analyzed for tense classification.</small>
                            </div>
                        </div>
                        <div class="card border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">
                                    <i class="bi bi-bullseye me-2"></i>Analyzed Sentence
                                </h5>
                                <p class="card-text fs-5 fw-bold analyzed-sentence">{{ result.analyzed_sentence }}</p>
                                <small class="text-muted">This is the sentence that was used for tense classification and grammar explanation.</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Fragment Warning (if fragment detected) -->
                {% if result.is_fragment %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-warning d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <div>
                                <strong>ข้อความไม่ใช่ประโยคสมบูรณ์</strong><br>
                                <small>ระบบตรวจพบว่าข้อความที่ป้อนไม่ใช่ประโยคสมบูรณ์ จึงไม่สามารถวิเคราะห์ tense ได้ กรุณาดูคำแนะนำด้านล่าง</small>
                            </div>
                        </div>
                        <div class="card border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning">
                                    <i class="bi bi-info-circle me-2"></i>ข้อความที่แปลได้
                                </h5>
                                <p class="card-text fs-5 fst-italic">{{ result.translation }}</p>
                                <small class="text-muted">ข้อความนี้ขาดประธาน (Subject) หรือกริยา (Verb) ที่จำเป็นสำหรับการวิเคราะห์ tense</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Tense Classification (only for complete sentences) -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary">Coarse Tense</h5>
                                <p class="card-text fs-3 fw-bold text-primary">
                                    {{ result.coarse_label }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success">Fine Tense</h5>
                                <p class="card-text fs-3 fw-bold text-success">
                                    {{ result.fine_label }}
                                </p>
                                <p class="text-muted">
                                    <i class="bi bi-speedometer2 me-2"></i>Confidence: {{ "%.1f"|format(result.confidence * 100) }}%
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Grammar Explanation / Fragment Guide -->
        <div class="card shadow mb-4">
            <div class="card-header {% if result.is_fragment %}bg-warning text-dark{% else %}bg-info text-white{% endif %}">
                <h4 class="mb-0">
                    {% if result.is_fragment %}
                    <i class="bi bi-book me-2"></i>คำแนะนำการสร้างประโยค
                    {% else %}
                    <i class="bi bi-lightbulb me-2"></i>Grammar Explanation
                    {% endif %}
                </h4>
            </div>
            <div class="card-body">
                {% if explanation_sections %}
                    {% for section_key, section in explanation_sections.items() %}
                        <div class="mb-4">
                            <h5 class="text-primary">
                                <i class="bi bi-bookmark"></i> <span lang="th">{{ section.title }}</span>
                            </h5>
                            <div class="ps-3">
                                <div class="explanation-content" lang="th">{{ section.content|safe }}</div>
                            </div>
                        </div>
                        {% if not loop.last %}
                            <hr class="my-3">
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No explanation available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Enhanced Rating Interface (Proficient Users Only) -->
        {% if current_user.is_authenticated and current_user.is_proficient() %}
        <div class="rating-container shadow mb-4" id="ratingCard">
            <div class="rating-header">
                <h3>Translation Quality Assessment</h3>
                <p>Help us improve by rating this translation</p>
            </div>
            
            <div class="rating-content">
                <div class="progress-indicator mb-4">
                    <div class="progress-bar" id="ratingProgress" style="width: 0%"></div>
                </div>
                
                <form id="ratingForm">
                    <input type="hidden" id="inputThai" value="{{ result.input_thai }}">
                    <input type="hidden" id="translationText" value="{{ result.translation }}">
                    
                    <div class="rating-section">
                        <div class="rating-title">Quality Assessment</div>
                        
                        <div class="multi-criteria-rating">
                            <!-- Translation Accuracy -->
                            <div class="criterion">
                                <div class="criterion-header">
                                    <span class="criterion-name">Translation Accuracy</span>
                                    <span class="criterion-help">Does the English correctly convey the Thai meaning?</span>
                                </div>
                                <div class="rating-scale">
                                    {% for i in range(1, 6) %}
                                    <div class="rating-option">
                                        <input type="radio" name="translation_accuracy" id="trans_acc{{ i }}" value="{{ i }}">
                                        <label for="trans_acc{{ i }}">
                                            {% if i == 1 %}Poor{% elif i == 2 %}Fair{% elif i == 3 %}Good{% elif i == 4 %}Very Good{% else %}Excellent{% endif %}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Translation Fluency -->
                            <div class="criterion">
                                <div class="criterion-header">
                                    <span class="criterion-name">Translation Fluency</span>
                                    <span class="criterion-help">Does the English sound natural?</span>
                                </div>
                                <div class="rating-scale">
                                    {% for i in range(1, 6) %}
                                    <div class="rating-option">
                                        <input type="radio" name="translation_fluency" id="trans_flu{{ i }}" value="{{ i }}">
                                        <label for="trans_flu{{ i }}">
                                            {% if i == 1 %}Poor{% elif i == 2 %}Fair{% elif i == 3 %}Good{% elif i == 4 %}Very Good{% else %}Excellent{% endif %}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Grammar Explanation Quality -->
                            <div class="criterion">
                                <div class="criterion-header">
                                    <span class="criterion-name">Grammar Explanation Quality</span>
                                    <span class="criterion-help">Is the grammar explanation accurate and helpful?</span>
                                </div>
                                <div class="rating-scale">
                                    {% for i in range(1, 6) %}
                                    <div class="rating-option">
                                        <input type="radio" name="explanation_quality" id="exp_qual{{ i }}" value="{{ i }}">
                                        <label for="exp_qual{{ i }}">
                                            {% if i == 1 %}Poor{% elif i == 2 %}Fair{% elif i == 3 %}Good{% elif i == 4 %}Very Good{% else %}Excellent{% endif %}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Educational Value -->
                            <div class="criterion">
                                <div class="criterion-header">
                                    <span class="criterion-name">Educational Value</span>
                                    <span class="criterion-help">How helpful is this for Thai English learners?</span>
                                </div>
                                <div class="rating-scale">
                                    {% for i in range(1, 6) %}
                                    <div class="rating-option">
                                        <input type="radio" name="educational_value" id="edu_val{{ i }}" value="{{ i }}">
                                        <label for="edu_val{{ i }}">
                                            {% if i == 1 %}Not Helpful{% elif i == 2 %}Slightly Helpful{% elif i == 3 %}Moderately Helpful{% elif i == 4 %}Very Helpful{% else %}Extremely Helpful{% endif %}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Quick Feedback Tags -->
                        <div class="quick-feedback">
                            <div class="comments-title">Quick Issues (Optional - Click any that apply)</div>
                            
                            <div class="tag-section">
                                <div class="tag-section-title">Translation Issues:</div>
                                <div class="quick-tags" data-category="translation">
                                    <span class="tag" data-tag="Wrong word choice">Wrong word choice</span>
                                    <span class="tag" data-tag="Missing context">Missing context</span>
                                    <span class="tag" data-tag="Too literal">Too literal</span>
                                    <span class="tag" data-tag="Awkward phrasing">Awkward phrasing</span>
                                    <span class="tag" data-tag="Grammar error">Grammar error</span>
                                    <span class="tag positive" data-tag="Perfect translation">Perfect translation</span>
                                </div>
                            </div>
                            
                            <div class="tag-section">
                                <div class="tag-section-title">Explanation Issues:</div>
                                <div class="quick-tags" data-category="explanation">
                                    <span class="tag" data-tag="Wrong grammar rule">Wrong grammar rule</span>
                                    <span class="tag" data-tag="Too complex">Too complex</span>
                                    <span class="tag" data-tag="Too basic">Too basic</span>
                                    <span class="tag" data-tag="Missing key points">Missing key points</span>
                                    <span class="tag" data-tag="Incorrect tense analysis">Incorrect tense analysis</span>
                                    <span class="tag" data-tag="Poor examples">Poor examples</span>
                                    <span class="tag positive" data-tag="Clear explanation">Clear explanation</span>
                                    <span class="tag positive" data-tag="Very educational">Very educational</span>
                                </div>
                            </div>
                        </div>

                        <!-- Comments Section -->
                        <div class="comments-section">
                            <div class="comments-title">Additional Comments (Optional)</div>
                            <textarea class="comments-textarea" id="comments" name="comments" 
                                      placeholder="Any specific feedback about the translation accuracy, grammar explanation quality, or suggestions for improvement for Thai English learners..."></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary" id="submitRating">Submit Rating</button>
                        <button type="button" class="btn btn-secondary" id="toggleRating">Hide Rating</button>
                    </div>
                </form>
                
                <div id="ratingSuccess" class="alert alert-success mt-3 d-none">
                    <i class="bi bi-check-circle me-2"></i>Thank you for your feedback! Your detailed rating has been submitted successfully.
                </div>
                
                <div id="ratingError" class="alert alert-danger mt-3 d-none">
                    <i class="bi bi-exclamation-triangle"></i> <span id="errorMessage">There was an error submitting your rating. Please try again.</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="text-center">
            <a href="{{ url_for('main.index') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-arrow-clockwise me-2"></i>Try Another Sentence
            </a>
            <a href="{{ url_for('main.system_performance') }}" class="btn btn-outline-secondary btn-lg ms-2">
                <i class="bi bi-speedometer2 me-2"></i>View Model Performance
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if current_user.is_authenticated and current_user.is_proficient() %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Track selected tags
    let selectedTags = [];
    
    // Tag selection functionality
    document.querySelectorAll('.tag').forEach(function(tag) {
        tag.addEventListener('click', function() {
            const tagText = this.getAttribute('data-tag');
            
            if (this.classList.contains('selected')) {
                this.classList.remove('selected');
                selectedTags = selectedTags.filter(t => t !== tagText);
            } else {
                this.classList.add('selected');
                selectedTags.push(tagText);
            }
        });
    });
    
    // Auto-update progress bar based on completed criteria
    document.addEventListener('change', function(e) {
        if (e.target.type === 'radio') {
            updateProgress();
        }
    });
    
    function updateProgress() {
        const criteria = ['translation_accuracy', 'translation_fluency', 'explanation_quality', 'educational_value'];
        const completed = criteria.filter(c => document.querySelector(`input[name="${c}"]:checked`)).length;
        const progress = (completed / criteria.length) * 100;
        document.getElementById('ratingProgress').style.width = progress + '%';
    }
    
    // Toggle rating visibility
    document.getElementById('toggleRating').addEventListener('click', function() {
        const card = document.getElementById('ratingCard');
        const form = document.getElementById('ratingForm');
        
        if (form.style.display === 'none') {
            form.style.display = 'block';
            this.innerHTML = 'Hide Rating';
            this.classList.remove('btn-secondary');
            this.classList.add('btn-outline-secondary');
        } else {
            form.style.display = 'none';
            this.innerHTML = 'Show Rating';
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-secondary');
        }
    });
    
    // Form submission
    document.getElementById('ratingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get all ratings
        const translationAccuracy = document.querySelector('input[name="translation_accuracy"]:checked')?.value;
        const translationFluency = document.querySelector('input[name="translation_fluency"]:checked')?.value;
        const explanationQuality = document.querySelector('input[name="explanation_quality"]:checked')?.value;
        const educationalValue = document.querySelector('input[name="educational_value"]:checked')?.value;
        
        // Validate all criteria are rated
        if (!translationAccuracy || !translationFluency || !explanationQuality || !educationalValue) {
            alert('Please provide ratings for all four quality criteria.');
            return;
        }
        
        const formData = {
            input_thai: document.getElementById('inputThai').value,
            translation_text: document.getElementById('translationText').value,
            translation_accuracy: parseInt(translationAccuracy),
            translation_fluency: parseInt(translationFluency),
            explanation_quality: parseInt(explanationQuality),
            educational_value: parseInt(educationalValue),
            issue_tags: selectedTags,
            comments: document.getElementById('comments').value.trim()
        };
        
        // Submit the rating
        submitRating(formData);
    });
    
    function submitRating(data) {
        const submitBtn = document.getElementById('submitRating');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
        
        fetch("{{ url_for('main.submit_rating') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(responseData => {
            if (responseData.success) {
                // Show success message
                document.getElementById('ratingSuccess').classList.remove('d-none');
                document.getElementById('ratingError').classList.add('d-none');
                
                // Hide the form
                document.getElementById('ratingForm').style.display = 'none';
                
                // Update toggle button
                const toggleBtn = document.getElementById('toggleRating');
                toggleBtn.innerHTML = 'Show Rating Form';
                toggleBtn.classList.remove('btn-outline-secondary');
                toggleBtn.classList.add('btn-secondary');
            } else {
                // Show error message
                const errorMsg = document.getElementById('errorMessage');
                errorMsg.textContent = responseData.error || 'There was an error submitting your rating. Please try again.';
                document.getElementById('ratingError').classList.remove('d-none');
                document.getElementById('ratingSuccess').classList.add('d-none');
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error submitting rating:', error);
            document.getElementById('ratingError').classList.remove('d-none');
            document.getElementById('ratingSuccess').classList.add('d-none');
            
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    }
});
</script>
{% endif %}
{% endblock %}